const cds = require('../../../../cds')
const LOG = cds.log('odata')

const { toODataResult } = require('../utils/result')

const { normalizeError } = require('../../../../common/error/frontend')

let _mps

const _get4Tenant = async (tenant, locale, service) => {
  if (cds._mtxEnabled && service._isExtended) {
    const edmx = await cds.mtx.getEdmx(tenant, service.name, locale)
    return edmx
  }
}

const _get4Toggles = async (tenant, locale, service, req) => {
  if (!_mps) _mps = await cds.connect.to('ModelProviderService')

  /*
   * ModelProviderService:
   *   action csn(tenant:TenantID, version:String, toggles: array of String) returns CSN;
   *   action edmx(tenant:TenantID, version:String, toggles: array of String, service:String, locale:Locale, odataVersion:String) returns XML;
   */
  const toggles = (req.features && Object.keys(req.features)) || []
  const edmx = await _mps.edmx(tenant, 'dummy', toggles, service.name, locale, 'v4')

  return edmx
}

/**
 * Provide localized metadata handler.
 *
 * @param {object} service
 * @returns {Function}
 */
const metadata = service => {
  return async (odataReq, odataRes, next) => {
    const req = odataReq.getIncomingRequest()

    const tenant = req.user && req.user.tenant

    // REVISIT: can we take locale from user, or is there some odata special wrt metadata?
    const locale = odataRes.getContract().getLocale()

    try {
      let edmx

      if (tenant) {
        const { alpha_toggles: alphaToggles } = cds.env.features
        edmx = alphaToggles
          ? await _get4Toggles(tenant, locale, service, req)
          : await _get4Tenant(tenant, locale, service)
      }

      if (!edmx) {
        edmx = cds.localize(
          service.model,
          locale,
          // REVISIT: we could cache this in a weak map
          cds.compile.to.edmx(service.model, { service: service.definition.name })
        )
      }

      return next(null, toODataResult(edmx))
    } catch (e) {
      if (LOG._error) {
        e.message = 'Unable to get EDMX for tenant ' + tenant + ' due to error: ' + e.message
        LOG.error(e)
      }
      // return 503 to client
      const { error, statusCode } = normalizeError(Object.assign(e, { statusCode: 503 }), req)
      return next(Object.assign(error, { statusCode }))
    }
  }
}

module.exports = metadata
